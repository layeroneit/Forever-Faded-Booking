# Forever Faded Booking

Barbershop booking and management app built for **AWS Amplify Gen 2** (TypeScript-first, code-first backend). Same features as [forever-faded-platform](https://github.com/layeroneit/forever-faded-platform), including services, appointments, locations, Stripe and email integrations — compatible with Amplify Hosting.

## Features (migrated from forever-faded-platform)

- **Auth:** Cognito (email/password) — replaces JWT
- **Data:** Locations, Services, Appointments, UserProfile (role: client | barber | manager | owner | admin)
- **Stripe:** Payment intents and webhooks — add via Lambda (see below)
- **Email:** Booking confirmations — add via Lambda + SES (see below)

## Prerequisites

- Node.js 18+
- npm
- AWS account (for Amplify sandbox / deploy)

## Quick start

### 1. Install and run sandbox

```bash
npm install
npx ampx sandbox
```

This deploys the Amplify backend (Auth + Data) and generates `amplify_outputs.json`. Keep the sandbox running in a terminal.

### 2. Run the frontend

In another terminal:

```bash
npm run dev
```

Open http://localhost:5173. Sign up / sign in with Cognito, then use Dashboard, Book, Appointments, Profile.

### 3. Add seed data and test users

- **Same profiles and users as the platform:** Sign up with the test accounts in **[TEST-USERS.md](./TEST-USERS.md)** (e.g. `owner@foreverfaded.com` / `password123`, then create a UserProfile in Data manager with role `owner`).
- **Location and services:** On the **Dashboard**, click **Seed location & services** to create the Waukesha location and the same service list as forever-faded-platform (Test Service $1, Face, Adults, Teens, Children, Seniors & Military).

Or create Location, Service, and UserProfile manually in **Amplify Console** → **Data** → **Data manager**.

## Stripe integration

The **Book** page supports pay-now via Stripe. Custom mutations are wired in `amplify/data/resource.ts`:

- **`createPaymentIntent`** — arguments: `appointmentId`, `amountCents` (optional). Returns `clientSecret` and `paymentIntentId` for Stripe Elements.

Set **backend** env in Amplify: `STRIPE_SECRET_KEY` (starts with `sk_`). Set **frontend** env: `VITE_STRIPE_PUBLISHABLE_KEY` (e.g. in `.env` and in Amplify Hosting env).

See **[STRIPE.md](./STRIPE.md)** for full setup and test cards.

## Email integration

The **send-email** Lambda is exposed as a custom mutation:

- **`sendEmail`** — arguments: `to`, `subject`, `text`. Returns `{ sent, error? }`. Uses AWS SES.

Set in Amplify: `MAIL_FROM` (verified SES identity). See **[EMAIL.md](./EMAIL.md)** for SES setup.

## Deploy to Amplify Hosting

1. Push this repo to GitHub (or connect Amplify to your repo).
2. In **AWS Amplify Console** → Create app → Host web app → connect repo and branch.
3. **Build:** The repo includes `amplify.yml` — preBuild: `npm ci`, build: `npm run build`, artifacts: `dist`. Use Node 18+ (set in Amplify build settings or use `engines` in package.json).
4. **SPA routing:** In Amplify Console → App settings → Rewrites and redirects → add: source `</^[^.]+$|\.(?!js|css|gif|jpg|jpeg|png|svg|ico|woff|woff2|ttf|eot)$/>`, target `/index.html`, type **200 (Rewrite)**.
5. **Backend:** Deploy the Amplify Gen 2 backend (Auth + Data + Lambdas) via `npx ampx sandbox` or pipeline; ensure `amplify_outputs.json` is available at build time (Amplify injects it when backend is deployed first).
6. Set environment variables (see STRIPE.md, EMAIL.md).

## Project structure

```
forever-faded-booking/
├── amplify/
│   ├── auth/resource.ts     # Cognito
│   ├── data/resource.ts     # Location, Service, Appointment, UserProfile
│   ├── backend.ts
│   └── functions/           # Stripe & email (wire in backend + data)
├── src/
│   ├── main.tsx             # Amplify.configure + Authenticator
│   ├── App.tsx
│   ├── components/
│   └── pages/
├── amplify_outputs.json     # Generated by sandbox (gitignored in prod)
├── package.json
└── README.md
```

## Migration from forever-faded-platform

| forever-faded-platform | Forever Faded Booking |
|------------------------|------------------------|
| Express + Prisma (SQLite) | Amplify Data (AppSync + DynamoDB) |
| JWT auth | Cognito |
| REST /api/* | GraphQL (Data client) + Lambda for Stripe/email |
| Vite proxy to Node | Same-origin to AppSync; Lambda for custom logic |

Services list (including Test Service $1.00) matches the seed in forever-faded-platform; add them via Data manager or a seed script.
