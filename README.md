# Forever Faded Booking

Barbershop booking and management app built for **AWS Amplify Gen 2** (TypeScript-first, code-first backend). Same features as [forever-faded-platform](https://github.com/layeroneit/forever-faded-platform), including services, appointments, locations, Stripe and email integrations — compatible with Amplify Hosting.

## Features (migrated from forever-faded-platform)

- **Auth:** Cognito (email/password) — replaces JWT
- **Data:** Locations, Services, Appointments, UserProfile (role: client | barber | manager | owner | admin)
- **Stripe:** Payment intents and webhooks — add via Lambda (see below)
- **Email:** Booking confirmations — add via Lambda + SES (see below)

## Prerequisites

- Node.js 18+
- npm
- AWS account (for Amplify sandbox / deploy)

## Quick start

### 1. Install and run sandbox

```bash
npm install
npx ampx sandbox
```

This deploys the Amplify backend (Auth + Data) and generates `amplify_outputs.json`. Keep the sandbox running in a terminal.

### 2. Run the frontend

In another terminal:

```bash
npm run dev
```

Open http://localhost:5173. Sign up / sign in with Cognito, then use Dashboard, Book, Appointments, Profile.

### 3. Add seed data

Use **Amplify Console** → your app → **Data** → **Data manager** to create:

- **Location:** e.g. Forever Faded — Waukesha, 1427 E Racine Ave Suite H, Waukesha, WI 53186
- **Service:** e.g. Test Service, category Test, duration 15 min, priceCents 100 ($1.00)
- **UserProfile:** link to your Cognito user (userId = sub), role `client` or `owner`, name, email, phone

Or use the Amplify Data client in the app to create locations and services.

## Stripe integration

To add Stripe (create payment intent, webhook):

1. **Lambda:** Use the handlers in `amplify/functions/create-payment-intent/` and add a webhook function. Register them in `amplify/backend.ts` and expose via custom queries/mutations in `amplify/data/resource.ts`.
2. **Secrets:** Set `STRIPE_SECRET_KEY` and `STRIPE_WEBHOOK_SECRET` in Amplify (Environment variables / Secrets).
3. **Frontend:** Use Stripe.js and call your custom mutation to get `clientSecret`, then confirm payment.

See [forever-faded-platform/server/src/routes/payments.js](https://github.com/layeroneit/forever-faded-platform/blob/main/server/src/routes/payments.js) for the original logic to port.

## Email integration

To send booking confirmation emails:

1. **Lambda:** Use `amplify/functions/send-email/` (SES) or add SMTP via a Lambda layer. Register in `amplify/backend.ts` and expose via a custom mutation.
2. **SES:** Verify your sending domain/address in AWS SES and set `MAIL_FROM` in the function environment.
3. **Trigger:** After creating an appointment, call the send-email mutation from the frontend or via a Data custom mutation resolver.

See [forever-faded-platform/server/src/lib/email.js](https://github.com/layeroneit/forever-faded-platform/blob/main/server/src/lib/email.js) for the original logic.

## Deploy to Amplify Hosting

1. Push this repo to GitHub (or connect Amplify to your repo).
2. In **AWS Amplify Console** → Create app → Host web app → connect repo and branch.
3. Build settings: use the default build (npm ci, npm run build). Output directory: `dist`.
4. Add **rewrite:** source `</^[^.]+$|\.(?!js|css|gif|jpg|jpeg|png|svg|ico|woff|woff2|ttf|eot)$/>` → `/index.html`, type **200 (Rewrite)** for SPA routing.
5. Deploy. The backend (Auth + Data) is deployed with the app when using Amplify Gen 2.

## Project structure

```
forever-faded-booking/
├── amplify/
│   ├── auth/resource.ts     # Cognito
│   ├── data/resource.ts     # Location, Service, Appointment, UserProfile
│   ├── backend.ts
│   └── functions/           # Stripe & email (wire in backend + data)
├── src/
│   ├── main.tsx             # Amplify.configure + Authenticator
│   ├── App.tsx
│   ├── components/
│   └── pages/
├── amplify_outputs.json     # Generated by sandbox (gitignored in prod)
├── package.json
└── README.md
```

## Migration from forever-faded-platform

| forever-faded-platform | Forever Faded Booking |
|------------------------|------------------------|
| Express + Prisma (SQLite) | Amplify Data (AppSync + DynamoDB) |
| JWT auth | Cognito |
| REST /api/* | GraphQL (Data client) + Lambda for Stripe/email |
| Vite proxy to Node | Same-origin to AppSync; Lambda for custom logic |

Services list (including Test Service $1.00) matches the seed in forever-faded-platform; add them via Data manager or a seed script.
